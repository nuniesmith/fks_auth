<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FKS Passkey Authentication Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .success {
            background: #d4edda;
        }

        .error {
            background: #f8d7da;
        }
    </style>
</head>

<body>
    <h1>FKS Passkey Authentication Demo</h1>

    <div class="container">
        <h2>Register Passkey</h2>
        <input type="text" id="regUsername" placeholder="Username" value="jordan">
        <input type="text" id="deviceName" placeholder="Device Name (optional)">
        <br>
        <button onclick="startRegistration()">Start Registration</button>
        <button onclick="completeRegistration()">Complete Registration</button>
        <div id="regResult" class="result" style="display:none;"></div>
    </div>

    <div class="container">
        <h2>Authenticate with Passkey</h2>
        <input type="text" id="authUsername" placeholder="Username" value="jordan">
        <br>
        <button onclick="startAuthentication()">Start Authentication</button>
        <button onclick="completeAuthentication()">Complete Authentication</button>
        <div id="authResult" class="result" style="display:none;"></div>
    </div>

    <script>
        const AUTH_URL = 'http://localhost:8009';
        let registrationSessionId = null;
        let registrationChallenge = null;
        let authSessionId = null;
        let authChallenge = null;
        let credential = null;

        // Helper: Convert ArrayBuffer to base64
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // Helper: Convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        async function startRegistration() {
            const username = document.getElementById('regUsername').value;
            const deviceName = document.getElementById('deviceName').value || null;

            try {
                const response = await fetch(`${AUTH_URL}/passkey/register/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, device_name: deviceName })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                registrationSessionId = data.session_id;
                registrationChallenge = data.challenge;

                // Convert challenge for browser API
                const publicKeyCredentialCreationOptions = {
                    ...registrationChallenge.publicKey,
                    challenge: base64ToArrayBuffer(registrationChallenge.publicKey.challenge),
                    user: {
                        ...registrationChallenge.publicKey.user,
                        id: base64ToArrayBuffer(registrationChallenge.publicKey.user.id)
                    }
                };

                // Store for completion
                registrationChallenge = publicKeyCredentialCreationOptions;

                document.getElementById('regResult').style.display = 'block';
                document.getElementById('regResult').className = 'result success';
                document.getElementById('regResult').textContent =
                    `Registration started!\nSession ID: ${registrationSessionId}\n\n` +
                    `Click "Complete Registration" to create the passkey.`;
            } catch (error) {
                document.getElementById('regResult').style.display = 'block';
                document.getElementById('regResult').className = 'result error';
                document.getElementById('regResult').textContent = `Error: ${error.message}`;
            }
        }

        async function completeRegistration() {
            if (!registrationSessionId || !registrationChallenge) {
                alert('Please start registration first!');
                return;
            }

            const username = document.getElementById('regUsername').value;
            const deviceName = document.getElementById('deviceName').value || null;

            try {
                // Create credential using browser WebAuthn API
                const credential = await navigator.credentials.create({
                    publicKey: registrationChallenge
                });

                // Prepare credential for server
                const credentialForServer = {
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                        attestationObject: arrayBufferToBase64(credential.response.attestationObject)
                    },
                    type: credential.type
                };

                // Send to server
                const response = await fetch(`${AUTH_URL}/passkey/register/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: registrationSessionId,
                        username,
                        credential: credentialForServer,
                        device_name: deviceName
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('regResult').className = 'result success';
                    document.getElementById('regResult').textContent =
                        `✅ Passkey registered successfully!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    throw new Error(data.message || 'Registration failed');
                }
            } catch (error) {
                document.getElementById('regResult').className = 'result error';
                document.getElementById('regResult').textContent = `Error: ${error.message}`;
            }
        }

        async function startAuthentication() {
            const username = document.getElementById('authUsername').value;

            try {
                const response = await fetch(`${AUTH_URL}/passkey/authenticate/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                authSessionId = data.session_id;
                authChallenge = data.challenge;

                // Convert challenge for browser API
                const publicKeyCredentialRequestOptions = {
                    ...authChallenge.publicKey,
                    challenge: base64ToArrayBuffer(authChallenge.publicKey.challenge),
                    allowCredentials: authChallenge.publicKey.allowCredentials?.map(cred => ({
                        ...cred,
                        id: base64ToArrayBuffer(cred.id)
                    }))
                };

                // Store for completion
                authChallenge = publicKeyCredentialRequestOptions;

                document.getElementById('authResult').style.display = 'block';
                document.getElementById('authResult').className = 'result success';
                document.getElementById('authResult').textContent =
                    `Authentication started!\nSession ID: ${authSessionId}\n\n` +
                    `Click "Complete Authentication" to authenticate with your passkey.`;
            } catch (error) {
                document.getElementById('authResult').style.display = 'block';
                document.getElementById('authResult').className = 'result error';
                document.getElementById('authResult').textContent = `Error: ${error.message}`;
            }
        }

        async function completeAuthentication() {
            if (!authSessionId || !authChallenge) {
                alert('Please start authentication first!');
                return;
            }

            const username = document.getElementById('authUsername').value;

            try {
                // Get credential using browser WebAuthn API
                const assertion = await navigator.credentials.get({
                    publicKey: authChallenge
                });

                // Prepare credential for server
                const credentialForServer = {
                    id: assertion.id,
                    rawId: arrayBufferToBase64(assertion.rawId),
                    response: {
                        clientDataJSON: arrayBufferToBase64(assertion.response.clientDataJSON),
                        authenticatorData: arrayBufferToBase64(assertion.response.authenticatorData),
                        signature: arrayBufferToBase64(assertion.response.signature),
                        userHandle: assertion.response.userHandle ?
                            arrayBufferToBase64(assertion.response.userHandle) : null
                    },
                    type: assertion.type
                };

                // Send to server
                const response = await fetch(`${AUTH_URL}/passkey/authenticate/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: authSessionId,
                        username,
                        credential: credentialForServer
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('authResult').className = 'result success';
                    document.getElementById('authResult').textContent =
                        `✅ Authentication successful!\n\n` +
                        `Access Token: ${data.access_token.substring(0, 50)}...\n` +
                        `Refresh Token: ${data.refresh_token.substring(0, 50)}...\n` +
                        `Expires At: ${new Date(data.expires_at * 1000).toLocaleString()}\n\n` +
                        `Full Response:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    throw new Error(data.message || 'Authentication failed');
                }
            } catch (error) {
                document.getElementById('authResult').className = 'result error';
                document.getElementById('authResult').textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>

</html>